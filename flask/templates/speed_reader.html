<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <style type="text/css">
    .middle {color:red;}
    .begin {width:40vw; text-align: right}
    .word {
        width:100%;
        display: flex;
        border-spacing:0;
        border:none;
        position: absolute;
        bottom: 5vw;
        overflow: hidden
    }
    .word > tbody {
        width:100%;
        font-size: 10vw;
    }
    .debug {
        display:none;
    }

    #output{
        position: absolute;
        margin: 0 50px;
        bottom: 22vw;
    }

    #output>span{
        white-space: pre-wrap;
    }
    </style>
    <script type="text/javascript" src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <title></title>
</head>
<body>
    <div id="wrapper">
        <div id="output">
            <span></span>
        </div>
        <table class="word">
        <tr>
            <td class="begin"></td><td class="middle"></td><td class="end"></td>
        </tr>
        </table>
    </div>
    <table class="debug" width="33.3333%" height="50px" style="border-right: solid white; position:absolute;">
    </table>
    <script type="text/javascript">
        var speed = 50; //Words per second
        var delay = 5; //ML thread delay
        var text = [];
        var data = "";
        var current_idx = 0;
        var beg = document.getElementsByClassName('begin');
        var mid = document.getElementsByClassName('middle');
        var end = document.getElementsByClassName('end');
        var out = document.getElementById('output');
        var repeater = null;
        
        document.addEventListener("DOMContentLoaded", function(){
            //connect to the socket server.
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            socket.on('generated_text', function(msg) {
                data = msg.text.split('<|endoftext|>')[0];
                output = document.getElementById('output');
                while(output.childElementCount > 20){
                    output.removeChild(output.firstChild); 
                }
                var tElement = document.createElement('span');
                if(msg.color) tElement.classList.add('color');
                output.appendChild(tElement);
                current_idx = 0;
                text = data.split(/\s/g);
                speed = msg.speed;
                if(repeater) {
                    clearInterval(repeater);
                }
                repeater = setInterval(nextText, 1000 / speed);
            });


            function nextText(){
                var t = "<<PAUSE>>";
                if(text.length != 0){
                    t = text[0];
                }
                else{
                    // beg[0].textContent = "";
                    // mid[0].textContent = "";
                    // end[0].textContent = "";
                    return;
                }
                if(!t){
                    text.shift();
                    nextText();
                    return;
                }
                if(t.length <= 2 && t.match(/[\?\,\;\.\!\:\"\)\]\}]$/g)){
                    text.shift();
                    nextText();
                    return;
                }
                if(t == "<<PAUSE>>"){
                    text.shift();
                    return;
                }
                var split = 4;
                if(t.length < 2) {
                    split = 0;
                } else if(t.length < 6) {
                    split = 1;
                }
                else if(t.length < 10) {
                    split = 2;
                }
                else if(t.length < 14) {
                    split = 3;
                }

                beg[0].textContent = t.slice(0        , split);
                mid[0].textContent = t.slice(split    , split + 1);
                end[0].textContent = t.slice(split + 1, t.length);
                text.shift();
                next_idx = data.slice(current_idx).search(encodeURI(t));
                if(next_idx < 0) next_idx = 1;
                current_idx = next_idx + current_idx;
                out.lastChild.textContent = data.slice(0,current_idx) + t;
                console.log(current_idx + "/" + data.length);

                if(t.match(/[?,;.!:"]$/g))
                {
                    text.unshift("<<PAUSE>>");
                    return;
                }
            };

        });
    </script>
</body>
</html>